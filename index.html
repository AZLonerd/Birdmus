<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Birdmus</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #111;
            color: white;
            position: relative
        }

        .upload-select {
            width: 120px;
            height: 120px;
            border: 2px dashed #555;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 20px;
        }


        .upload-result {
            margin-top: 10px;
        }

        canvas {
            width: 100%;
            height: 400px;
            background: black;
            display: none;
        }

        audio {
            display: none;
        }

        #playBtn {
            padding: 10px 20px;
            font-size: 18px;
            background: green;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 15%;
            background-color: gray;
            border-radius: 10%;
        }

        .bar {
            width: 5%;
            height: 100%;
            background-color: #2EFF2E;
            animation-name: bar;
            animation-iteration-count: 1;
            animation-duration: 5s;
            animation-fill-mode: forwards;
        }

        @keyframes bar {
            to {
                width: 100%;
            }
        }

        .music-progress-bar {
            position: relative;
            height: 50px;
            width: 300px;
            background-color: #0096FF
        }

        .percentage {
            --percent-value: 0%;
            position: absolute;
            height: 100%;
            width: var(--percent-value);
            background-color: #D3D3D3
        }

        #HomepageBtn {
            width: 200px;
            height: 40px;
            background-color: rgb(0, 0, 0, 0.8);
            transition: 0.3s;
            font-weight: 800;
            color: gold;
        }

        #HomepageBtn:hover {
            cursor: pointer;
            background-color: grey;
        }


        .finish-page {
            position: fixed;
            top: -30%;

            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            background: #2c2c2c;
            color: #fff;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0px 8px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: none;

            animation: finishpageanimation 0.6s forwards;
        }


        .finish-page p {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }


        .finish-page button {
            padding: 10px 20px;
            background: #4cafef;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            margin: auto;
            display: block;
        }

        .finish-page button:hover {
            background: #2196f3;
            transform: translateY(-2px);
        }

        /* Animation (slide down only) */
        @keyframes finishpageanimation {
            from {
                top: -30%;
                opacity: 0;
            }

            to {
                top: 20%;
                opacity: 1;
            }
        }

        .tutorialbtn {
            width: 120px;
            height: 50px;
            color: gold;
            background-color: rgb(59, 59, 59);
            font-weight: 800;

        }

        .tutorialbtn:hover {
            cursor: pointer;
            color: darkcyan;
            background-color: rgb(59, 59, 59);
            font-weight: 800;

        }

        .exclaimation {
            display: inline-block;
            color: red;
            margin-right: 10px;
            animation: swing 2s infinite ease-in-out;

        }

        .mustbe {
            color: white;
            font-weight: 600;
            margin: auto;
            width: fit-content;
        }

        @keyframes swing {
            0% {
                transform: rotate(15deg);
            }

            50% {
                transform: rotate(-15deg);
            }

            100% {
                transform: rotate(15deg);
            }
        }

        .gameover .container {
            display: block;
        }


        .pointsdiv {
            display: none;
            position: absolute;
            left: 55%;
            top: 0%;
            width: 40%;
        }

        .defaultaudiocontainer {
            font-family: sans-serif;
            margin: auto;
            padding: 16px;

            border-radius: 12px;
            max-width: 400px;
        }

        .song-container {
            margin: auto;
            width: fit-content;
            margin-top: 10px;
        }

        .defaultaudiocontainer button {
            width: 300px;
            height: auto;
            border-radius: 12px;
            font-weight: 700;
            font-size: 20px;
            margin-top: 10px;
            background: #1e1e1e;
            color: #f5f5f5;
        }

        .defaultaudiocontainer button:hover {
            cursor: pointer;
            width: 300px;
            height: auto;
            border-radius: 12px;
            font-weight: 700;
            font-size: 20px;
            background-color: #2a2a2a;
        }



        .song-instruction {
            font-size: 15px;
            font-weight: 800;
            margin: auto;
            width: fit-content
        }

        .dance-with-me,
        .champagne-ocean {
            display: flex;
            align-items: center;
            justify-content: flex-start;

            gap: 8px;
        }

        .dancewithmeicon::before,
        .champagneoceanicon::before {
            content: "▶️";
            position: static;

        }


        .yellowsquare {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: yellow;
        }

        .game-btn {
            background-color: #222;
            color: yellow;
            border: 2px solid yellow;
            border-radius: 8px;
            margin-left: 10px;
            padding: 10px 10px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            position: relative;
        }

        .game-btn::after {
            content: "What's the Hotkey?";
        }

        .game-btn:hover::after {
            content: "WASD for movement"
        }


        .btntoreducecount {
            position: fixed;
            left: 47%;
            transform: translateY(-50%);

            width: 100px;
            height: 50px;
            display: none;


            background: radial-gradient(circle at 30% 30%, #1a1a2e, #0f0f1f);
            color: #fff;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;

            border: 2px solid #00f0ff;

            border-radius: 12px;
            box-shadow: 0 0 15px #00f0ff, 0 0 30px #00f0ff, 0 0 45px #ff00ff;

            cursor: pointer;
            transition: all 0.2s ease-in-out;

            /* Pulsing animation */
            animation: pulse 1s infinite ease-in-out;
        }

        /* Animation keyframes */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px #00f0ff, 0 0 30px #00f0ff, 0 0 45px #ff00ff;
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 25px #00f0ff, 0 0 50px #ff00ff, 0 0 75px #00ffea;
            }

            100% {
                transform: scale(1);

                box-shadow: 0 0 15px #00f0ff, 0 0 30px #00f0ff, 0 0 45px #ff00ff;
            }
        }

        .btntoreducecount:hover {
            transform: scale(1.05);

            box-shadow: 0 0 30px #00f0ff, 0 0 60px #ff00ff, 0 0 90px #00ffea;
        }

        .btntoreducecount:active {
            transform: scale(1.1);
            box-shadow: 0 0 15px #00f0ff, 0 0 30px #ff00ff;
        }

        .numneedtoclick {
            position: fixed;
            top: 1%;
            left: 50%;
            transform: translateX(-50%);

            min-width: 80px;
            padding: 12px 22px;

            font-size: 36px;
            font-weight: 800;
            letter-spacing: 2px;
            text-align: center;
            color: #00f6ff;

            background: radial-gradient(circle at top, #0b1d3a, #040812);
            border: 2px solid #00f6ff;
            border-radius: 14px;

            box-shadow:
                0 0 10px #00f6ff,
                0 0 25px rgba(0, 246, 255, 0.6),
                inset 0 0 12px rgba(0, 246, 255, 0.4);

            text-shadow:
                0 0 6px #00f6ff,
                0 0 12px #00f6ff;

            user-select: none;
            pointer-events: none;
            z-index: 999;
        }

        .tp-meter {
            position: fixed;
            top: 10px;
            left: 15%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            /* vertically center items */
            gap: 10px;
        }

        .teleporttext {
            font-family: "Orbitron", "Trebuchet MS", sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #00f6ff;
            letter-spacing: 1px;
            padding: 4px 8px;
            margin: 0;

            text-shadow:
                0 0 4px #00f6ff,
                0 0 8px rgba(0, 246, 255, 0.6),
                0 0 12px rgba(0, 246, 255, 0.4);

            transition: 0.2s ease;
            user-select: none;
        }

        .tp-segment {
            width: 55px;
            height: 14px;
            border-radius: 20px;

            background: rgba(255, 255, 255, 0.08);
            border: 1px solid #8be9ff;
            box-shadow: inset 0 0 6px rgba(139, 233, 255, 0.4);

            opacity: 0.25;
            transition: 0.2s ease;
        }

        .tp-segment.active {
            opacity: 1;
            background: linear-gradient(90deg, #00f6ff, #00ffd5);
            box-shadow:
                0 0 8px #00f6ff,
                0 0 18px rgba(0, 246, 255, 0.8);
        }


        .pointsp {
            display: inline-flex;
            align-items: center;
            gap: 22px;
            white-space: nowrap;

            margin: 10px auto;
            padding: 12px 28px;

            background: linear-gradient(145deg, rgba(5, 10, 30, 0.9), rgba(10, 20, 60, 0.85));
            border: 2px solid rgba(120, 180, 255, 0.6);
            border-radius: 14px;

            box-shadow:
                0 0 12px rgba(120, 180, 255, 0.4),
                inset 0 0 12px rgba(120, 180, 255, 0.2);

            font-family: "Orbitron", "Trebuchet MS", sans-serif;
            font-size: 16px;
            color: white;
            letter-spacing: 1px;
            user-select: none;
        }


        .pointsp .pointspan {
            font-size: 22px;
            font-weight: bold;
            color: yellow;
            text-shadow: 0 0 10px rgba(255, 216, 77, 0.9);
        }


        .pointsp .bluepointsspan {
            font-size: 22px;
            font-weight: bold;
            color: #4dc3ff;
            text-shadow: 0 0 10px rgba(77, 195, 255, 0.9);
        }

        .pointsp {
            animation: hudGlow 3s ease-in-out infinite alternate;
        }

        @keyframes hudGlow {
            from {
                box-shadow: 0 0 10px rgba(120, 180, 255, 0.3),
                    inset 0 0 10px rgba(120, 180, 255, 0.15);
            }

            to {
                box-shadow: 0 0 22px rgba(120, 180, 255, 0.7),
                    inset 0 0 14px rgba(120, 180, 255, 0.25);
            }
        }

        .teleporttext {

            font-family: "Orbitron", "Trebuchet MS", sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #00f6ff;
            letter-spacing: 1px;
            margin-right: 8px;



            transition: 0.2s ease;
            padding-top: 30px;
            user-select: none;
            margin-bottom: 30px;
        }

        .leftbtn,
        .rightbtn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            background: #1c2230;
            /* dark space panel */
            border: 1px solid #3a4156;
            /* subtle edge */
            color: #cfd6e6;
            font-size: 18px;
            cursor: pointer;
        }

        .leftbtn::before {
            content: "◀";
        }

        .rightbtn::before {
            content: "▶";
        }

        .leftbtn:hover,
        .rightbtn:hover {
            background: #242b3d;
            /* very subtle feedback */
        }

        .leftbtn:active,
        .rightbtn:active {
            background: #141926;
        }


        .slide-btn {
            display: block;
        }


        @media (max-width: 1200px) {
            .slide-btn {
                display: none;
            }
        }
    </style>

    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="upload.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <div class="pointsdiv">
        <div style="display: flex;">
            <p class="pointsp">Total yellow points: <span class="pointspan">0</span>
                <span>total blue points <span class="bluepointsspan">0</span></span>
            <div class="tp-meter" id="tpMeter">
                <p class="teleporttext">Teleport:</p>
                <div class="tp-segment"></div>
                <div class="tp-segment"></div>
                <div class="tp-segment"></div>
                <div class="tp-segment"></div>
                <div class="tp-segment"></div>
            </div>
            </p>
        </div>
        <p class="" style="color: red; margin-top:-5px">

            <span class="cross">❌</span>
            <span class="ifpassedcheck">you need <span class="pointsneeded">0</span> yellow points to pass</span>

            <span class="bluepointsneededcheck" style="margin-left: 5%; color:red "><span class="cross2">❌</span>you
                need
                <span class="bluepointsneededspan">0</span> blue points to
                pass
            </span>
        </p>

    </div>
    <div class=" upload select">
        <div class="upload-select" id="uploadBox" style="margin:auto">
            <p class="plus-icon">+</p>
            <input class="inputbox" type="file" accept=".mp3,audio/*" hidden />
            <div class="progress-bar" style="display:none">
                <div class="bar"></div>
                <p>loading</p>
            </div>
        </div>

        <div class="introduction"
            style="margin:auto; width:fit-content;margin-top: 50px; font-weight: 800; font-size: 15px;">
            upload your
            favorite
            music to
            get started</div>
        <div class="mustbe">⚠️Warning:must be .mp3 file</div>
        <div class="tutorial-container" style="width:fit-content; position: relative; left:80%; top:-80px">
            <button class="tutorialbtn"><span class="exclaimation">!!</span>tutorial</button>
            <div class="tutorial" style="display: none;">

                <div class="container2" style="width: 200px">
                    <div class="allslide">
                        <div class="slide">
                            <img src="uploadmusic.PNG" width="200px" height="200px" />
                        </div>
                        <div class="slide">
                            <img src="wasdfor.PNG" width="200px" height="200px" />
                        </div>
                        <div class="slide">
                            <img src="dodgesound4.PNG" width="200px" height="200px" />
                        </div>
                        <div class="slide">
                            <img src="contacting yellow.PNG" width="200px" height="200px" />
                        </div>
                        <div class="slide">
                            <img src="bluepoints2.PNG" width="200px" height="200px" />
                        </div>
                        <div class="slide">
                            <img src="tpinstructionfinal.PNG" width="200px" height="200px" />
                        </div>

                    </div>

                    <div class="indicator">
                        <span class="active"></span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>

                </div>
            </div>
        </div>
        <div style="position: fixed; left:79%; top:49%">
            <button class="slide-btn leftbtn" style="visibility: hidden;"></button>
        </div>
        <div style="position: fixed; left: 90%; top:49%">
            <button class="slide-btn rightbtn" style="visibility: hidden;"></button>
        </div>
        <div class="defaultaudiocontainer" style="margin-top: 20px;">
            <p class="song-instruction">Don't got songs? Use some of the songs here</p>
            <div style="height:auto;" class="song-container">
                <div style="height: auto;">
                    <audio class="default-audio" src=""></audio>
                    <button class="champagne-ocean">
                        <p class="champagneoceanicon">Ehrling-Champagne Ocean</p>
                    </button>
                </div>
                <div class="song two" style="height:auto">
                    <audio class="default-audio-two" src=""></audio>
                    <button class="dance-with-me">
                        <p class="dancewithmeicon">Ehrling-dance with me</p>
                    </button>
                </div>
            </div>

        </div>

        <div class="upload-result"></div>
        <div style="display:none" class="pause-container">
            <div class="pause-icon">
                <i class="fa-solid fa-pause"></i>
            </div>

        </div>

        <div style="display: none;" class="resume-icon">
            <i class="fa-solid fa-play"></i>
        </div>


    </div>

    <div class="gameover" style="display:none; height:auto;">

        <div class="container" style="padding: 1px;">
            <h2 class="gameover-text">Game over</h2>
            <p style="margin-top: 80px" class="percentdone"></p>
            <button id="restart-game">Restart game</button>
        </div>

    </div>

    <div class="pause-page">

        <div class="pause-page-instruction">
            <p>you paused the game</p>
        </div>
        <div class="button-container" style="display: block;">
            <div class="pausebtn">
                <button class="pause-restartbtn" id="restart-game3">Restart game</button>
            </div>


            <div class="pausebtn">
                <button class="resume-gamebtn">Resume game</button>
            </div>

        </div>

    </div>

    <div class="finish-page" style="display: none;background-color: gray;">
        <p class="finish-page-p"></p>
        <div style="display:flex">
            <button id="restart-game2">Restart game</button>
        </div>

    </div>

    <canvas>

    </canvas>

    <audio></audio>
    <!-- music play progress bar -->

    <div class="containerforcanvaspage">
        <div><button id="playBtn">▶️ Play Music</button></div>
        <div class="progress-container" style="display: flex;">
            <div style="display: none;" class="music-progress-bar">
                <div class="percentage"></div>
            </div>
            <div class="progress-bar-finish" style="display: none;user-select: none;">Finish</div>
        </div>

        <div>
            <button class="btntoreducecount"
                style="width: 100px; height: 50px; display: none;user-select: none;">Click!!!</button>
        </div>

        <div class="numneedtoclick" style="display: none;"></div>

        <div class="gobacktohomecontainer">
            <button id="HomepageBtn" style="display: none">
                go back to Home page
            </button>
        </div>

    </div>





    <div class="bullet"></div>
    <div class="bullet"></div>
    <div class="bullet"></div>
    <div class="bullet"></div>


    <script>
        const fileInput = document.querySelector(".inputbox");
        const uploadBox = document.getElementById("uploadBox");
        const resultBox = document.querySelector(".upload-result");
        const canvas = document.querySelector("canvas");
        const ctx = canvas.getContext("2d");
        const audio = document.querySelector("audio");
        const playBtn = document.getElementById("playBtn");
        const bar = document.querySelector(".progress-bar")
        const plus = document.querySelector(".plus-icon")

        const pointsneed = document.querySelector(".pointsneeded")

        const music_progress_bar = document.querySelector(".music-progress-bar")

        const pause_page = document.querySelector(".pause-page")
        const mustbe = document.querySelector(".mustbe")


        const resumebutton = document.querySelector(".resume-gamebtn")


        const tutorial = document.querySelector(".tutorial")
        const tutorialbtn = document.querySelector(".tutorialbtn")

        const introduction = document.querySelector(".introduction")
        const progressFinish = document.querySelector(".progress-bar-finish")

        const dancewithme = document.querySelector(".dance-with-me")
        const default_audio = document.querySelector(".default-audio")
        const champagneOcean = document.querySelector(".champagne-ocean")
        const default_audio2 = document.querySelector(".default-audio-two")
        const pointsdiv = document.querySelector(".pointsdiv")

        const btntoreducecount = document.querySelector(".btntoreducecount")
        const cross = document.querySelector(".cross")
        const cross2 = document.querySelector(".cross2")
        const numneedtoclick = document.querySelector(".numneedtoclick")
        const bluepointsneededspan = document.querySelector(".bluepointsneededspan")
        const bluepointsspan = document.querySelector(".bluepointsspan")
        let nameofthedefaultsong = ""

        const leftbtn = document.querySelector(".leftbtn")
        const rightbtn = document.querySelector(".rightbtn")
        champagneOcean.addEventListener("click", () => {
            default_audio.src = "Ehrling - Champagne Ocean [No copyright Music].mp3"
            nameofthedefaultsong = "champagneOcean"
        })
        dancewithme.addEventListener("click", () => {
            default_audio.src = "Ehrling - Dance With Me.mp3"
            nameofthedefaultsong = "danceWithme"
        })


        const bulletImg = new Image();
        bulletImg.src = "meteor3.png";



        tutorialbtn.addEventListener("click", () => {
            if (tutorial.style.display === "block") {
                tutorial.style.display = "none";
                tutorialbtn.innerHTML = "tutorial";
                leftbtn.style.visibility = "hidden"
                rightbtn.style.visibility = "hidden"
                tutorialbtn.classList.remove("closebtn");
            } else {
                tutorial.style.display = "block";
                tutorialbtn.innerHTML = "close";
                leftbtn.style.visibility = "visible"
                rightbtn.style.visibility = "visible"
                tutorialbtn.classList.add("closebtn");

            }
        });




        let shouldWarn = true;

        let requirementnotreached = true;
        let requirementnotreached2 = true;


        window.addEventListener("beforeunload", function (event) {
            if (shouldWarn) {
                event.preventDefault();
                audio.pause();

                event.returnValue = '';

            }
        });



        const moveSpeed = 3;
        let isInit = false;
        let analyzer, dataArray;
        let stopped = false;

        let interval1

        let percentcalculation
        const percentage = document.querySelector(".percentage")
        const finishpage = document.querySelector(".finish-page")



        const progressContainer = document.querySelector(".progress-container")


        const slides = document.querySelectorAll('.slide');
        const indicatorSpans = document.querySelectorAll('.indicator span');
        const allslide = document.querySelector('.allslide');

        let currentIndex = 0;

        let percentagetodisplay = 0;

        const homebtn = document.getElementById("HomepageBtn")
        let bulletx = 0

        let lastBulletSpawnTime = 0;
        let bulletSpawnInterval = 8;

        let climax
        let bulletfrequencytriggered = true;

        let bulletfrequencyinterval = 10;
        let lastfrequencyTime = 0
        let baseSpeed = 0.3
        let baseDiagSpeed = 0.2;
        let bullets = []
        let initialinit = true;

        let climaxoverlast3s = []
        let checkevery1s = 0.6;
        let lastchecktime = 0


        let ifclimaxreached = false;
        let ifclimaxreachedinterval = 5;

        let animationFrameId;

        let pointsarr = [];

        let isatloadingpage = false;


        let targetpositionarr = [];
        const targetpositionimage = new Image();
        targetpositionimage.src = "portal.png"; // your image path


        let inittargetpositionarr = true;

        let totalpoints = 0;
        let totalbluepoints = 0

        let bluepointsneeded = 0;


        let lastpointspawntime = 0;
        let lastpointdeletetime = 0;

        let lasttargetpositionspawntime = 0;
        let lasttargetpositondissapeartime = 0;

        const totalSlides = slides.length;

        let targetColors = {
            0: { r: 170, g: 170, b: 70 },
            1: { r: 230, g: 180, b: 75 },
            2: { r: 220, g: 170, b: 70 },
            3: { r: 210, g: 120, b: 40 },
            4: { r: 180, g: 90, b: 30 }
        };

        let stage = 0;
        lastupdatebackgroundcolortime = 0;
        let targetColor = targetColors[0];

        let spawnfrequencyfortargetposition
        let timesneedtoclick
        let targetpositiondissapeartime


        let timelefttoteleport = 5
        const MAX_TP = 5;
        let teleportEnabled = false;



        leftbtn.addEventListener("click", () => {
            if (currentIndex == 0) {
                return
            }
            currentIndex -= 1;
            updateSlider();
        })

        rightbtn.addEventListener("click", () => {
            if (currentIndex > indicatorSpans.length - 2) {
                return
            }
            currentIndex += 1;
            updateSlider();
        })

        function updateSlider() {
            allslide.style.transform = `translateX(${-currentIndex * 200}px)`;

            indicatorSpans.forEach((span, idx) => {
                span.classList.toggle('active', idx === currentIndex);
            });
        }

        indicatorSpans.forEach((span, index) => {
            span.addEventListener("click", () => {
                currentIndex = index;
                updateSlider();
            })
        })




        function setMusicprogressbar() {


            percentcalculation = audio.currentTime / audio.duration * 100

            percentage.style.setProperty("--percent-value", `${percentcalculation}%`)


            if (!audio.paused && !audio.ended) {
                requestAnimationFrame(setMusicprogressbar);
            }
            percentagetodisplay = percentcalculation


        }

        const ifpassedcheck = document.querySelector(".ifpassedcheck")
        const bluepointsneededcheck = document.querySelector(".bluepointsneededcheck")

        let audioDuration;
        const repeatedTimes = Math.floor(audioDuration / 5) + 1;

        let bar5width = 30;

        const pauseicon = document.querySelector(".pause-container")
        const resumeicon = document.querySelector(".resume-icon")

        const finishpagep = document.querySelector(".finish-page-p")


        let bulletbar = [];

        let numberneedtoclick;
        let collisionActive = false;

        resumebutton.addEventListener("click", () => {
            pause_page.style.display = "none";
            pauseicon.style.display = "block"
            resumeicon.style.display = "none"
            startinterval();
            requestAnimationFrame(setMusicprogressbar)
            audio.play();
        })

        pauseicon.addEventListener("click", () => {
            audio.pause()
            resumeicon.style.display = "block"
            pauseicon.style.display = "none"
            pause_page.style.display = "block"



            clearInterval(interval1);


        })








        function initCanvas() {
            canvas.width = window.innerWidth * devicePixelRatio;
            canvas.height = 400 * devicePixelRatio;
        }

        initCanvas();

        uploadBox.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("input", () => {
            bar.style.display = "block";
            plus.style.display = "none";
        });

        fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            handleFile(file);
        });

        uploadBox.addEventListener("dragenter", (e) => {
            e.preventDefault();
            uploadBox.classList.add("dragover");
        });
        uploadBox.addEventListener("dragover", (e) => e.preventDefault());
        uploadBox.addEventListener("dragleave", () => uploadBox.classList.remove("dragover"));
        uploadBox.addEventListener("drop", (e) => {
            e.preventDefault();
            uploadBox.classList.remove("dragover");

            const file = e.dataTransfer.files[0];
            handleFile(file);
        });


        function handleFile(file) {
            if (!file) return;

            bar.style.display = "block";
            plus.style.display = "none";

            const name = file.name.toLowerCase();
            const isMp3 = name.endsWith(".mp3");
            const isAudio = file.type.startsWith("audio/");
            const maxSize = 10 * 1024 * 1024;

            if (!isMp3 || !isAudio) {
                resultBox.textContent = " File must be a valid .mp3 audio.";
                return;
            }

            if (file.size > maxSize) {
                resultBox.textContent = `File too large. Max 10MB. Your file: ${(file.size / 1024 / 1024).toFixed(2)}MB`;
                return;
            }

            setTimeout(() => {
                const audioURL = URL.createObjectURL(file);
                audio.src = audioURL;

                const maxLen = 50;
                let displayName = file.name;
                if (displayName.length > maxLen) {
                    displayName = displayName.substring(0, maxLen - 3) + "...";
                }
                resultBox.textContent = `✅ Ready: ${displayName}`;
            }, 5000);
        }

        audio.addEventListener("canplaythrough", () => {
            document.querySelector(".defaultaudiocontainer").style.display = "none";
            homebtn.style.display = "block";
            tutorial.style.display = "none";
            canvas.style.display = "block";
            introduction.style.display = "none";
            pointsdiv.style.display = "block";

            if (nameofthedefaultsong === "champagneOcean") {
                resultBox.textContent = "✅Ehrling - Champagne Ocean.mp3"

            } else if (nameofthedefaultsong === "danceWithme") {

                resultBox.textContent = "✅Ehrling - Dance With Me.mp3"
            }


            uploadBox.style.display = "none";
            playBtn.style.display = "inline-block";
            resultBox.style.display = "block";
            mustbe.style.display = "none";
            isatloadingpage = true;
            leftbtn.style.visibility = "hidden"
            rightbtn.style.visibility = "hidden"

            pointsneed.innerHTML = pointstopassLevel();
            bluepointsneededspan.innerHTML = bluepointstopassLevel();
        });


        playBtn.addEventListener("click", () => {
            music_progress_bar.style.display = "inline-block"
            music_progress_bar.style.marginRight = "auto"
            progressContainer.style.marginRight = "auto"
            progressFinish.style.display = "block"
            isatloadingpage = false

            startinterval();
            audioDuration = audio.duration;
            pauseicon.style.display = "block"
            audio.play();
            setMusicprogressbar()

            playBtn.style.display = "none";

        });








        homebtn.addEventListener('click', gobacktohomepage);

        function gobacktohomepage() {

            nameofthedefaultsong = void 0;
            fileInput.value = '';
            totalpoints = 0
            progressFinish.style.display = "none"

            if (tutorialbtn.classList.contains("closebtn")) {
                tutorialbtn.textContent = "tutorial";
            }
            tutorialbtn.style.display = "block";
            tutorial.style.display = "none";

            gameover.style.display = "none"





            lastpointdeletetime = 0;
            lastpointspawntime = 0;

            lastBulletSpawnTime = 0;
            pointsarr = []
            clearBullets();
            bulletx = 0;

            bird.x = canvas.width / 8;
            bird.y = canvas.height / 2;

            clearInterval(interval1)
            canvas.style.display = 'none';
            introduction.style.display = "block";

            pointsdiv.style.display = "none"

            uploadBox.style.display = "flex";
            playBtn.style.display = "none";


            cross.innerHTML = "❌"
            requirementnotreached = true;
            requirementnotreached2 = true;
            currentIndex = 0;
            updateSlider();

            bar.style.display = "none";
            plus.style.display = "block";
            pauseicon.style.display = "none";
            resumeicon.style.display = "none";
            music_progress_bar.style.display = "none";
            resultBox.style.display = "none";
            homebtn.style.display = "none";
            finishpage.style.display = "none";
            pause_page.style.display = "none";

            teleportEnabled = false;
            baseSpeed = 0.3
            baseDiagSpeed = 0.2;
            bar5width = 30
            document.querySelector(".defaultaudiocontainer").style.display = "block"
            initialinit = true;

            stage = 0;
            lastupdatebackgroundcolortime = 0;
            targetColor = targetColors[0];


            leftbtn.style.visibility = "hidden"
            rightbtn.style.visibility = "hidden"

            targetpositionarr = []
            lasttargetpositionspawntime = 0;
            collisionActive = false;
            lastpointspawntime = 0;
            totalpoints = 0;
            timelefttoteleport = 5
            cross2.innerHTML = "❌"
            inittargetpositionarr = true;
            totalbluepoints = 0;
            bluepointsspan.textContent = 0;
            ifpassedcheck.style.color = "red"
            bluepointsneededcheck.style.color = "red"
            updateTPMeter();



            audio.src = "";
            audio.load();
        }

        audio.onplay = function () {
            if (isInit) return;



            const audCtx = new AudioContext();
            const source = audCtx.createMediaElementSource(audio);

            analyzer = audCtx.createAnalyser();
            analyzer.fftSize = 512;
            dataArray = new Uint8Array(analyzer.frequencyBinCount);

            source.connect(analyzer);
            analyzer.connect(audCtx.destination);

            isInit = true;
        };

        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        function lerp(a, b, t) {
            return a + (b - a) * t;
        }

        class Point {
            constructor() {
                this.r = 4;
                this.x = random(100, canvas.width - 100);
                this.y = random(100, canvas.height - 200);
                this.tx = this.x;
                this.ty = this.y;
            }

            update() {
                this.x = lerp(this.x, this.tx, 0.005);
                this.y = lerp(this.y, this.ty, 0.005);
                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 1) {
                    const range = 40;
                    this.tx = this.x + random(-range, range);
                    this.ty = this.y + random(-range, range);
                }
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
                ctx.fillStyle = "white";
                ctx.fill();
            }
        }

        class Graph {
            constructor(count = 60) {
                this.points = new Array(count).fill(0).map(() => new Point());
            }

            update() {
                this.points.forEach(p => p.update());
            }

            draw() {
                this.points.forEach(p => p.draw());
            }
        }

        const g = new Graph(40);

        const birdimg = new Image();
        birdimg.src = "./bird2.PNG";

        let birdLoaded = false;

        birdimg.onload = () => {
            birdLoaded = true;
        };


        const bird = {
            x: canvas.width / 8,
            y: canvas.height / 2,
            width: 39,
            height: 39,
            hitboxes: [
                { xOffset: 8, yOffset: 5, width: 25, height: 20 }, // head
                { xOffset: 0, yOffset: 25, width: 39, height: 10 }, // wings/body
                { xOffset: 10, yOffset: 35, width: 20, height: 10 }  // tail/feet
            ]
        };




        const segments = document.querySelectorAll(".tp-segment");

        function updateTPMeter() {
            segments.forEach((seg, index) => {
                seg.classList.toggle("active", index < timelefttoteleport);
            });
        }

        function useTeleport() {
            if (timelefttoteleport > 0) {
                timelefttoteleport--;
                updateTPMeter();
            }
        }

        function addTeleport(amount = 1) {
            if (timelefttoteleport === 5) {
                return;
            }
            timelefttoteleport += amount;
            updateTPMeter();
        }

        updateTPMeter();


        const keys = { w: false, a: false, s: false, d: false };
        document.addEventListener('keydown', (e) => {
            if (e.key in keys) keys[e.key] = true;
        });
        document.addEventListener('keyup', (e) => {
            if (e.key in keys) keys[e.key] = false;
        });



        function isGameActive() {

            //isatloadingpage
            return (
                !isatloadingpage &&
                pause_page.style.display !== "block" &&
                gameover.style.display !== "block" &&
                finishpage.style.display !== "block"
            );
        }


        document.addEventListener("keydown", (e) => {
            if (!isGameActive()) {
                teleportEnabled = false;
                return;
            }
            if ((e.key === "t" || e.key === "T") && !teleportEnabled) {
                if (timelefttoteleport > 0) {
                    useTeleport();
                    teleportEnabled = true;

                }
            }
        });


        canvas.addEventListener("click", (e) => {
            if (!isGameActive()) {
                teleportEnabled = false;
                return;
            }

            if (teleportEnabled) {
                const rect = canvas.getBoundingClientRect();


                let mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
                let mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);


                bird.x = mouseX - bird.width / 2;
                bird.y = mouseY - bird.height / 2;

                teleportEnabled = false;

            }
        });


        function isColliding(rect1, rect2) {
            return (
                rect1.x < rect2.x + rect2.width &&
                rect1.x + rect1.width > rect2.x &&
                rect1.y < rect2.y + rect2.height &&
                rect1.y + rect1.height > rect2.y
            );
        }


        //check if rect2 is inside rect1
        function isInside(rect1, rect2) {
            return (
                rect2.x >= rect1.x &&
                rect2.y >= rect1.y &&
                rect2.x + rect2.width <= rect1.x + rect1.width &&
                rect2.y + rect2.height <= rect1.y + rect1.height
            );
        }

        function isCollidingcirrec(circle, rect) {
            const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));
            const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));

            const dx = circle.x - closestX;
            const dy = circle.y - closestY;

            return dx * dx + dy * dy < circle.radius * circle.radius;
        }



        btntoreducecount.addEventListener("click", () => {

            if (numberneedtoclick > 0) {
                numberneedtoclick--;
                numneedtoclick.innerHTML = numberneedtoclick;

                if (numberneedtoclick === 0) {
                    totalbluepoints += 100
                    if ((Math.floor(totalbluepoints) / 100) % 2 === 1) {
                        addTeleport();
                    }
                    numneedtoclick.style.display = "none"
                    bluepointsspan.innerHTML = totalbluepoints
                }
            }


        })





        function startinterval() {
            if (audio.play()) {
                interval1 = setInterval(() => {
                    if (stopped) return;
                    if (bar5width < canvas.width / 2) {
                        bar5width += 3;
                    }

                    // move y upward as height grows
                }, 1000);
            }
        }




        function generatepointstopass(divisor) {

            return function result() {
                const songduration = audio.duration;
                const totalpointstopasslevel = 100 + (Math.floor(songduration / divisor)) * 100

                return totalpointstopasslevel
            }
        }

        let pointstopassLevel = generatepointstopass(20);
        let bluepointstopassLevel = generatepointstopass(35);




        function checkifpasslevel(num) {
            return pointstopassLevel() <= num;
        }

        function checkifbluepointspasslevel(num) {
            return bluepointstopassLevel() <= num
        }






        function restartgame() {
            cancelAnimationFrame(animationFrameId);
            music_progress_bar.style.display = "none";
            pauseicon.style.display = "none";
            resumeicon.style.display = "none";


            gameover.style.display = "none"



            stage = 0;
            lastupdatebackgroundcolortime = 0;
            targetColor = targetColors[0];

            if (pause_page) pause_page.style.display = "none";
            playBtn.style.display = "inline-block";

            lastpointdeletetime = 0;


            cross.innerHTML = "❌"
            requirementnotreached = true;
            requirementnotreached2 = true;

            progressFinish.style.display = "none"

            clearInterval(interval1);
            stopped = false;
            baseSpeed = 0.3
            baseDiagSpeed = 0.2;
            clearBullets();
            bulletx = 0;
            lastBulletSpawnTime = 0;
            bulletSpawnInterval = 8;
            climax = 0;
            bulletfrequencytriggered = true;
            lastfrequencyTime = 0;
            bulletfrequencyinterval = 10;
            initialinit = true;


            climaxoverlast3s = []
            checkevery1s = 1;
            lastchecktime = 0

            bullets = [];

            ifclimaxreached = false;
            ifclimaxreachedinterval = 5;

            bird.x = canvas.width / 8;
            bird.y = canvas.height / 2;
            bar5width = 30;
            pointsarr = [];


            teleportEnabled = false;
            targetpositionarr = []
            lasttargetpositionspawntime = 0;
            collisionActive = false;
            lastpointspawntime = 0;
            totalpoints = 0;
            timelefttoteleport = 5
            cross2.innerHTML = "❌"
            inittargetpositionarr = true;
            totalbluepoints = 0;
            bluepointsspan.textContent = 0;
            ifpassedcheck.style.color = "red"
            bluepointsneededcheck.style.color = "red"
            isatloadingpage = true;
            updateTPMeter();



            audio.pause();
            audio.currentTime = 0;




            masterLoop();
        }



        function randombulletYstarting(leftorright) {
            let a
            let rand = Math.floor(Math.random() * 2)
            if (rand == 1) {
                a = Math.floor(Math.random() * (100) + (canvas.height / 2))
            } else {
                a = (canvas.height / 2) - Math.floor(Math.random() * 100)
            }
            return a
        }

        function randomXstarting(leftorright) {
            //1910     /2 = 955
            const a = Math.floor(Math.random() * 300 + 1 + (canvas.width / 2 - 150))
            return a
        }



        function changebulletSpawnFrequency() {
            if (bulletSpawnInterval <= 9 && bulletSpawnInterval > 8) {
                for (let i = 0; i < 1; i++) {
                    initBullets(0);
                }
            } else if (bulletSpawnInterval <= 8 && bulletSpawnInterval > 7.5) {
                for (let i = 0; i < 2; i++) {
                    initBullets(0);
                }
            } else {
                for (let i = 0; i < 3; i++) {
                    initBullets(1);
                }
            }
            return;
        }






        function bulletmovementspeedup() {
            bullets.forEach(bullet => {
                if (bullet.speedX > 0) {
                    bullet.speedX += 0.2;
                } else if (bullet.speedX < 0) {
                    bullet.speedX -= 0.2;
                }

                if (bullet.speedY > 0) {
                    bullet.speedY += 0.2;
                } else if (bullet.speedY < 0) {
                    bullet.speedY -= 0.2;
                }
            });
        }


        function bulletmovementspeedup2() {
            bullets.forEach(bullet => {
                if (bullet.speedX > 0) {
                    bullet.speedX += 0.35;
                } else if (bullet.speedX < 0) {
                    bullet.speedX -= 0.35;
                }

                if (bullet.speedY > 0) {
                    bullet.speedY += 0.35;
                } else if (bullet.speedY < 0) {
                    bullet.speedY -= 0.35;
                }
            });
        }



        function initBullets(num) {

            for (let i = 0; i < 3; i++) {
                let bullet = {
                    x: 0,
                    y: 0,
                    radius: 15,
                    speedX: 0,
                    speedY: 0
                };

                if (num === 0) {
                    // Left to right
                    bullet.x = 0;
                    bullet.y = randombulletYstarting();
                    bullet.speedX = baseSpeed;
                    bullet.speedY = (i === 0 ? baseDiagSpeed : i === 2 ? -baseDiagSpeed : 0);

                } else if (num === 1) {
                    // Right to left
                    bullet.x = canvas.width - bullet.radius;
                    bullet.y = randombulletYstarting();
                    bullet.speedX = -baseSpeed;
                    bullet.speedY = (i === 0 ? baseDiagSpeed : i === 2 ? -baseDiagSpeed : 0);

                } else if (num === 2) {
                    // Top to bottom
                    bullet.x = randomXstarting();
                    bullet.y = 0;
                    bullet.speedX = (i === 0 ? baseDiagSpeed : i === 2 ? -baseDiagSpeed : 0);
                    bullet.speedY = baseSpeed;


                } else if (num === 3) {
                    // Bottom to top
                    bullet.x = randomXstarting();
                    bullet.y = canvas.height - bullet.radius;
                    bullet.speedX = (i === 0 ? baseDiagSpeed : i === 2 ? -baseDiagSpeed : 0);
                    bullet.speedY = -baseSpeed;

                }

                bullets.push(bullet);
            }
        }






        function Checkclimaxreached() {

            let total = 0
            if (climaxoverlast3s.length >= 5) {

                for (let i = 0; i < 5; i++) {
                    total += climaxoverlast3s[i];
                }
                let averageMusicvolume = Math.floor(total / 5);

                if (averageMusicvolume > 220 && averageMusicvolume < 230) {

                    stage = 1
                } else if (averageMusicvolume >= 230 && averageMusicvolume < 240) {

                    stage = 2
                } else if (averageMusicvolume >= 240 && averageMusicvolume < 250) {

                    stage = 3;
                } else if (averageMusicvolume > 250) {

                    stage = 4
                } else {
                    stage = 0
                }

                climaxoverlast3s = [];
                return stage;
            }

            return stage;
        }



        function CheckifClimax() {

            const reachedstage1 = Checkclimaxreached();
            if (reachedstage1 === 1) {
                baseSpeed = 0.5
                baseDiagSpeed = 0.4
                ifclimaxreached = true;
                bulletSpawnInterval = 8;

                spawnfrequencyfortargetposition = 10
                targetpositiondissapeartime = 12
                if (bar5width < canvas.width / 2) {
                    bar5width += 1;
                }


            } else if (reachedstage1 === 2) {
                baseSpeed = 0.7
                baseDiagSpeed = 0.5
                ifclimaxreached = true;
                bulletSpawnInterval = 7;
                spawnfrequencyfortargetposition = 8
                timesneedtoclick = 5
                targetpositiondissapeartime = 11
                if (bar5width < canvas.width / 2) {
                    bar5width += 2;
                }


            } else if (reachedstage1 === 3) {
                baseSpeed = 0.8
                baseDiagSpeed = 0.7
                ifclimaxreached = true;
                bulletSpawnInterval = 6;
                spawnfrequencyfortargetposition = 7
                timesneedtoclick = 9
                targetpositiondissapeartime = 10
                if (bar5width < canvas.width / 2) {
                    bar5width += 3;
                }


            } else if (reachedstage1 === 4) {
                baseSpeed = 1
                baseDiagSpeed = 0.8
                ifclimaxreached = true;
                bulletSpawnInterval = 5;
                spawnfrequencyfortargetposition = 6
                timesneedtoclick = 11
                targetpositiondissapeartime = 9
                if (bar5width < canvas.width / 2) {
                    bar5width += 4;
                }

            } else {
                bulletSpawnInterval = 5.5;
                baseSpeed = 0.3;
                baseDiagSpeed = 0.2;
                spawnfrequencyfortargetposition = 5
                timesneedtoclick = 13
                targetpositiondissapeartime = 8
            }
        }



        function clearBullets() {
            bullets.length = 0;
        }



        function generatespawnpointbuilder(width, height, forceMiddle = false) {
            return function () {

                const minX = (500 / 1910) * canvas.width;
                const maxX = (canvas.width / 2) + minX;
                const x = Math.floor(Math.random() * (maxX - minX) + minX);

                let y;

                if (forceMiddle) {
                    // perfectly centered
                    y = (canvas.height - height) / 2;
                } else {
                    // near the middle
                    const centerY = canvas.height / 2;
                    const spread = 40;
                    y = Math.floor(Math.random() * (spread * 2) + (centerY - spread));
                }

                return { x, y, width, height };
            }
        }



        let generatespawnpointforpoints = generatespawnpointbuilder(25, 25, false);
        let generatespawnpointfortargetposition = generatespawnpointbuilder(70, 70, true);





        const pointspan = document.querySelector(".pointspan")
        const gameover = document.querySelector(".gameover")


        function clearpointsfromcanvas(point) {
            pointsarr = pointsarr.filter((ele) => {
                return ele !== point;
            })
        }


        let currentColor = { r: 26, g: 26, b: 26 }; // initial RGB

        function lerpColor(c1, c2, t) {
            return {
                r: c1.r + (c2.r - c1.r) * t,
                g: c1.g + (c2.g - c1.g) * t,
                b: c1.b + (c2.b - c1.b) * t
            };
        }



        function rgbToString(c) {
            return `rgb(${Math.round(c.r)},${Math.round(c.g)},${Math.round(c.b)})`;
        }

        function determinehowmanytimestoclick(number) {
            const currentime = Number(number);

            if (currentime <= 20) {
                return 12
            } else if (currentime > 20 && currentime <= 40) {
                return 10;
            } else if (currentime > 40 && currentime <= 90) {
                return 8;
            } else if (currentime > 90 && currentime <= 140) {
                return 6
            } else {
                return 3;
            }
        }





        function throttle(fn, space) {

            let lasttime = 0;


            return function a(...args) {
                let currenttime = Date.now();
                if (currenttime - lasttime > space) {
                    fn.apply(this, args)
                    lasttime = currenttime
                }

                currenttime = Date.now();
            }
        }



        function masterLoop() {
            if (stopped) return;
            animationFrameId = requestAnimationFrame(masterLoop);
            const { width, height } = canvas;
            ctx.clearRect(0, 0, width, height);

            g.update();
            g.draw();





            if (pause_page.style.display == "block") {


                if (keys.w) bird.y -= 0;
                if (keys.s) bird.y += 0;
                if (keys.a) bird.x -= 0;
                if (keys.d) bird.x += 0;

            } else if (gameover.style.display === "block") {
                if (keys.w) bird.y -= 0;
                if (keys.s) bird.y += 0;
                if (keys.a) bird.x -= 0;
                if (keys.d) bird.x += 0;

            } else if (finishpage.style.display === "block") {
                if (keys.w) bird.y -= 0;
                if (keys.s) bird.y += 0;
                if (keys.a) bird.x -= 0;
                if (keys.d) bird.x += 0;
            } else {


                if (keys.w) bird.y -= moveSpeed;
                if (keys.s) bird.y += moveSpeed;
                if (keys.a) bird.x -= moveSpeed;
                if (keys.d) bird.x += moveSpeed;
            }

            if (birdLoaded) {
                ctx.drawImage(birdimg, bird.x, bird.y, bird.width, bird.height);

            }

            if (checkifpasslevel(totalpoints) && requirementnotreached) {
                ifpassedcheck.style.color = "green"
                cross.innerHTML = "✅"
                requirementnotreached = false;

            }

            if (checkifbluepointspasslevel(totalbluepoints) && requirementnotreached2) {
                bluepointsneededcheck.style.color = "green"
                cross2.innerHTML = "✅"
                requirementnotreached2 = false;
            }



            if (audio.ended) {

                if (checkifpasslevel(totalpoints) && checkifbluepointspasslevel(totalbluepoints)) {
                    finishpage.style.display = "block"
                    finishpage.style.position = "absolute"

                    pauseicon.style.display = "none"
                    finishpagep.textContent = `You passed the song! your total points is ${totalpoints + totalbluepoints}`
                    clearInterval(interval1);
                } else {
                    const pointsdiff = pointstopassLevel() - totalpoints
                    const bluepointsdiff = bluepointstopassLevel() - totalbluepoints
                    finishpage.style.display = "block"
                    gameover.style.opacity = "0"

                    if (pointstopassLevel() === 100) {
                        finishpagep.textContent = `points not enough, you are ${pointsdiff} yellow points and ${bluepointsdiff}blue points from passing(audio too short)`
                    }

                    if (pointsdiff > 0 && bluepointsdiff > 0) {
                        finishpagep.textContent = `points not enough, you are ${pointsdiff} yellow points and ${bluepointsdiff} blue points from passing `
                    } else if (pointsdiff > 0) {
                        finishpagep.textContent = `points not enough, you are ${pointsdiff} yellow points from passing`
                    } else if (bluepointsdiff > 0) {
                        finishpagep.textContent = `points not enough, you are ${bluepointsdiff} blue points from passing`
                    }

                    clearInterval(interval1)
                }

            }





            if (isInit) {
                analyzer.getByteFrequencyData(dataArray);


                const len = dataArray.length / 4;
                const barWidth = width / len / 2;


                ctx.fillStyle = "green"

                if (!audio.paused) {

                    const last25percent = Math.floor(audio.duration / 4)
                    if (audio.duration - audio.currentTime < last25percent) {
                        bulletSpawnInterval = 5;

                    }

                    if (audio.currentTime >= 1 && initialinit) {
                        initBullets(0);
                        initialinit = false;
                    }

                    if (audio.currentTime - lastfrequencyTime > 10) {
                        lastfrequencyTime = audio.currentTime;
                        CheckifClimax();
                    }
                    if (bulletSpawnInterval === 8) {
                        if (audio.currentTime - lastBulletSpawnTime > 6) {

                            bulletmovementspeedup();
                            initBullets(0);
                            initBullets(2);

                            lastBulletSpawnTime = audio.currentTime;
                        }
                    } else if (bulletSpawnInterval === 7) {
                        if (audio.currentTime - lastBulletSpawnTime > 5) {

                            bulletmovementspeedup();
                            initBullets(1);
                            initBullets(3);

                            lastBulletSpawnTime = audio.currentTime;
                        }
                    } else if (bulletSpawnInterval === 6) {
                        if (audio.currentTime - lastBulletSpawnTime > 4) {
                            bulletmovementspeedup();

                            if (audio.duration - audio.currentTime < 60) {

                                initBullets(1);
                                initBullets(4);
                                initBullets(0);
                                initBullets(2);

                            } else {
                                initBullets(0);
                                initBullets(2);
                            }

                            lastBulletSpawnTime = audio.currentTime;
                        }
                    } else if (bulletSpawnInterval === 5) {
                        if (audio.currentTime - lastBulletSpawnTime > 2.5) {

                            bulletmovementspeedup2();

                            initBullets(0);
                            initBullets(1)
                            initBullets(2);
                            initBullets(3)





                            lastBulletSpawnTime = audio.currentTime;
                        }
                    } else {
                        if (audio.currentTime - lastBulletSpawnTime > 5.5) {
                            initBullets(0);

                            initBullets(1)

                            lastBulletSpawnTime = audio.currentTime;
                        }
                    }





                    if (audio.currentTime - lastpointspawntime > 10) {
                        const pointspawn = generatespawnpointforpoints();


                        pointsarr.push(pointspawn);
                        lastpointspawntime = audio.currentTime;

                    }




                    if (inittargetpositionarr) {
                        targetpositionarr.push({ x: 500, y: 200, width: 70, height: 70 })
                        inittargetpositionarr = false;
                    }

                    if (audio.currentTime - lasttargetpositionspawntime > 12) {
                        collisionActive = true;
                        numberneedtoclick = determinehowmanytimestoclick(audio.currentTime)
                        numneedtoclick.style.display = "block"
                        numneedtoclick.innerHTML = numberneedtoclick

                        const targetpositionspawn = generatespawnpointfortargetposition();
                        targetpositionarr.push(targetpositionspawn)
                        if (targetpositionarr.length === 2) {
                            targetpositionarr.shift();
                        }
                        lasttargetpositionspawntime = audio.currentTime;

                    }



                    if (audio.currentTime - lastpointdeletetime > 25) {
                        pointsarr.shift()
                        lastpointdeletetime = audio.currentTime;
                    }

                    pointsarr.forEach(p => {
                        ctx.fillStyle = "yellow";
                        ctx.fillRect(p.x, p.y, p.width, p.height);
                    });




                    targetpositionarr.forEach((ele, index) => {
                        if (index === 0) {
                            ctx.drawImage(
                                targetpositionimage,
                                ele.x,
                                ele.y,
                                ele.width,
                                ele.height
                            );
                        }
                    });


                    bullets.forEach((bullet) => {
                        // move bullet
                        bullet.x += bullet.speedX;
                        bullet.y += bullet.speedY;

                        // draw bullet image
                        ctx.drawImage(
                            bulletImg,
                            bullet.x - bullet.radius,
                            bullet.y - bullet.radius,
                            bullet.radius * 2,
                            bullet.radius * 2
                        );

                        // draw border around bullet (circle)
                        ctx.beginPath();
                        ctx.arc(bullet.x, bullet.y, bullet.radius, 0, 2 * Math.PI);
                        ctx.strokeStyle = "yellow"; // border color
                        ctx.lineWidth = 3;           // border thickness
                        ctx.stroke();
                    });


                    // bullets = bullets.filter(bullet =>
                    //     bullet.x + bullet.width > 0 &&
                    //     bullet.x < canvas.width &&
                    //     bullet.y + bullet.height > 0 &&
                    //     bullet.y < canvas.height
                    // );


                }







                if (audio.currentTime - lastupdatebackgroundcolortime > 10) {
                    targetColor = targetColors[stage] || targetColors[0];




                    lastupdatebackgroundcolortime = audio.currentTime;
                }

                currentColor = lerpColor(currentColor, targetColor, 0.05);

                ctx.fillStyle = rgbToString(currentColor);


                const bar5 = { x: 0, y: 0, width: bar5width, height: canvas.height }

                const bar6 = { x: canvas.width - 10, y: 0, width: 10, height: canvas.height }


                ctx.fillRect(bar5.x, bar5.y, bar5.width, bar5.height);
                ctx.fillRect(bar6.x, bar6.y, bar6.width, bar6.height);

                for (let i = 0; i < len; i++) {
                    const data = dataArray[i];
                    const barHeight = (data / 255) * height / 4 + 10  //originally was 2.7



                    const x1 = i * barWidth + width / 2;
                    const x2 = width / 2 - (i + 1) * barWidth;
                    const yBottom = height - barHeight;
                    const yTop = 0;

                    const bar1 = { x: x1, y: yBottom, width: barWidth - 2, height: barHeight };
                    const bar2 = { x: x2, y: yBottom, width: barWidth - 2, height: barHeight };
                    const bar3 = { x: x1, y: yTop, width: barWidth - 2, height: barHeight };
                    const bar4 = { x: x2, y: yTop, width: barWidth - 2, height: barHeight };

                    climax = Math.max(...dataArray)

                    ctx.fillRect(bar1.x, bar1.y, bar1.width, bar1.height);
                    ctx.fillRect(bar2.x, bar2.y, bar2.width, bar2.height);
                    ctx.fillRect(bar3.x, bar3.y, bar3.width, bar3.height);
                    ctx.fillRect(bar4.x, bar4.y, bar4.width, bar4.height);


                    //collision to check if user dodged bullets and sound wave
                    if ([bar1, bar2, bar3, bar4, bar5, bar6].some(bar => isColliding(bird, bar))) {

                        stopped = true;
                        audio.pause();
                        clearBullets();
                        gameover.style.display = "block"
                        const percentdone = document.querySelector(".percentdone")
                        percentdone.innerHTML = `you are ${percentagetodisplay.toFixed(2)}% done with the song`

                        pauseicon.style.display = "none"
                        homebtn.style.display = "none"



                        return;
                    }

                    if ([...bullets].some((circle) => {
                        return isCollidingcirrec(circle, bird)
                    })) {
                        stopped = true;
                        audio.pause();
                        clearBullets();
                        gameover.style.display = "block"
                        btntoreducecount.style.display = "none"
                        const percentdone = document.querySelector(".percentdone")
                        percentdone.innerHTML = `you are ${percentagetodisplay.toFixed(2)}% done with the song`

                        pauseicon.style.display = "none"
                        homebtn.style.display = "none"

                        return;
                    }

                    if ([...targetpositionarr].some(target => isInside(target, bird))) {

                        btntoreducecount.style.display = "block";

                        if (!collisionActive) {   //  only runs ONCE per collision
                            collisionActive = true;

                            const timestoclick = Math.floor(audio.currentTime);
                            numberneedtoclick = determinehowmanytimestoclick(timestoclick);

                            numneedtoclick.style.display = "block";
                            numneedtoclick.innerHTML = numberneedtoclick;

                        }

                        if (numberneedtoclick === 0) {
                            collisionActive = true;
                            targetpositionarr.shift();
                        }




                    } else {
                        btntoreducecount.style.display = "none";
                        numneedtoclick.style.display = "none"
                        collisionActive = false; // reset when no longer colliding
                    }


                }

                if (pause_page.style.display === "block") {
                    btntoreducecount.style.display = "none"
                    if (keys.w) bird.y -= 0;
                    if (keys.s) bird.y += 0;
                    if (keys.a) bird.x -= 0;
                    if (keys.d) bird.x += 0;
                }


                const collidedPoint = pointsarr.find(ele => isColliding(bird, ele));

                if (collidedPoint) {
                    totalpoints += 100;
                    pointsarr = pointsarr.filter(p => p !== collidedPoint);

                }

                pointspan.textContent = totalpoints;


                if (audio.currentTime - lastchecktime > checkevery1s) {
                    climaxoverlast3s.push(climax);
                    lastchecktime = audio.currentTime
                }
            }
        }


        masterLoop();
        const restartbtn = document.getElementById("restart-game")
        restartbtn.addEventListener("click", () => {
            restartgame();

        })

        const restartbtn2 = document.getElementById("restart-game2")
        restartbtn2.addEventListener("click", () => {
            finishpage.style.display = "none"
            restartgame();

        })

        const pause_restart = document.getElementById("restart-game3")

        pause_restart.addEventListener("click", () => {
            restartgame()

        });


    </script>
</body>

</html>